<!DOCTYPE html>
<html lang=en>
<head><title>Pling Plong Odometer Online</title>

<link rel="stylesheet" href="/media/bootstrap.min.css" integrity="sha256-QUyqZrt5vIjBumoqQV0jM8CgGqscFfdGhN+nVCqX0vc=" crossorigin="anonymous">
<link rel="stylesheet" href="/media/tingle.min.css" >
<script type="text/javascript" src="/media/tingle.min.js"></script>

<style type="text/css">
    .duration { text-align: right; 
                padding-right: 1em;
                font-family: Courier New, Courier, monospace;
              }


    .dragover { border: 6px double blue;

    }
</style>

<script type="text/javascript">

function secs2timestring(duration) {
    // takes an integer of seconds, responds with a "mm:ss" timestring
    var mins = parseInt(duration / 60);
    var secs = duration % 60;
    return mins.toString() + ":" + secs.toString();
}

function removeChildren(node) {
    while(node.hasChildNodes()) {
        node.removeChild(node.firstChild);
    }
}

function startProgress(max) {
    console.log('creating progress bar with max=%o', max);
   document.getElementById('th-metadata').innerHTML = "<progress id=progress value=0 class=align-bottom max="+max+"></progress>";
}

function updateProgress(val) {
    console.log('updating progress bar with val=%o', val);
    var p = document.getElementById('progress');
    var newval = parseInt(p.getAttribute('value'))+val;
    if(newval == p.getAttribute('max')) {
        // all resolve tasks are finished, remove progressbar
        p.parentElement.innerHTML = 'metadata';
    } else {
        p.setAttribute('value', newval);
    }
}

function main() {
    var form = document.getElementById('file-form');
    var fileSelect = document.getElementById('file-select');
    var uploadButton = document.getElementById('upload-button');
    var uploadTestfileButton = document.getElementById('upload-testfile-button');
    var fileList = document.getElementById('files-list');
    var resolveAllButton = document.getElementById('resolve-all-button');
    var createReportButton = document.getElementById('create-report-button');
    var createCreditsButton = document.getElementById('create-credits-button');

    // set up empty table
    var tr = document.createElement('tr');
    tr.innerHTML = '<td>|<td><td><td>';
    for (var i=0; i<60; i++) {
        fileList.appendChild(tr.cloneNode(true));
    }

    // create empty modal for later
    window.modalmodal = new tingle.modal({
        footer: true,
        stickyFooter: false,
        closeLabel: "Close",
        closeMethods: ['overlay', 'button', 'escape'],
    });
    // add a button
    window.modalmodal.addFooterBtn('Lukk', 'tingle-btn tingle-btn--primary', function() {
    // here goes some logic
        window.modalmodal.close();
    });


    uploadTestfileButton.onclick = function(event) {
        event.preventDefault();
        // empty files table
        removeChildren(fileList);
        var formData = new FormData();
        formData.append('usetestfile', '1');
        submit(formData);
        return false;
    }

    form.onsubmit = function(event) {
        event.preventDefault();

        // Update button text.
        uploadButton.innerHTML = 'Uploading...';

        // The rest of the code will go here...
        // Get the selected files from the input.
        var files = fileSelect.files;
        // Create a new FormData object.
        var formData = new FormData();
        // Loop through each of the selected files.
        for (var i = 0; i < files.length; i++) {
            var file = files[i];

            // Add the file to the request.
            formData.append('xmeml', file, file.name);
        }
        submit(formData)
        return false;
    }
    resolveAllButton.onclick = function(event) {
        event.preventDefault();
        // resolve all resolvable tracks
        var resolvables = document.querySelectorAll('#files-list .metadata.resolvable'); 
        startProgress(resolvables.length);
        for (var i = 0; i < resolvables.length; i++) {
            var url = resolvables[i].timelinedata.resolve;
            resolve(url);
        }

    }

    createReportButton.onclick = function(event) {
        event.preventDefault();
        reportdialog();
    }

    createCreditsButton.onclick = function(event) {
        event.preventDefault();
        creditsdialog();
    }

}

function submit(formData) {
    // Set up the request.
    var xhr = new XMLHttpRequest();
    // Open the connection.
    xhr.open('POST', '/analyze', true);

    var uploadButton = document.getElementById('upload-button');
    // Set up a handler for when the request finishes.
    xhr.onload = function () {
        if (xhr.status === 200) {
            // File(s) uploaded.
            uploadButton.innerHTML = 'Upload';
            var audio = JSON.parse(xhr.response);
            console.log('got audio response: %o', audio);
            return formatAudible(audio["audioclips"]);
        } else {
            alertmsg("server returned "+ xhr.status+": "+xhr.statusText, 'danger');
            uploadButton.innerHTML = 'Upload';
        }
    };

    // Send the Data.
    xhr.send(formData);
}

function formatAudible(audible) {
    var fileList = document.getElementById('files-list');
    // empty files table
    removeChildren(fileList);

    for(var i=0; i<audible.length; i++) {
        var tr = document.createElement('tr');
        var elm = audible[i];
        var c = elm.clipname;
        var r = elm.resolve;
        var secs = secs2timestring(elm.audible_length);
        var service = elm.music_service || "<i>Unknown</i>";
        tr.innerHTML = "<td>"+c+"<td class=duration>"+secs+"<td>"+service+"<td class=metadata id='o-"+window.btoa(r)+"'>";
        // keep the info around as a javascript object
        tr.lastChild.timelinedata = elm;
        if(elm.resolvable) {
           tr.firstChild.classList.add('text-success');
           tr.lastChild.classList.add('resolvable');
        }
        fileList.appendChild(tr);
    }
}

function resolve(url) {
    // Set up the request.
    var xhr = new XMLHttpRequest();
    // Open the connection.
    xhr.open('GET', url, true);

    var output = document.getElementById('o-'+window.btoa(url));
    // Set up a handler for when the request finishes.
    output.innerText = "Getting metadata..."
    xhr.onload = function () {
        if (xhr.status === 200) {
            // File(s) uploaded.
            var response = JSON.parse(xhr.response);
            console.log('got response %o', response);
            var md = response['metadata'];
            output.classList.add('has-metadata', 'text-success');
            output.metadata = md;
            if(md.productionmusic === true) {
                output.innerHTML = "<i>"+md.copyright+"</i> &reg; <b>"+md.label+"</b>";

            } else {
                output.innerHTML = "<i>"+md.title+"</i> "+md.artist+" &reg; <b>"+md.label+"</b> "+md.year;
                //s += u'%(title)s\r\n%(artist)s\r\n \u2117 %(label)s %(year)s\r\n\r\n' % vars(r.metadata)
            }
        } else if(xhr.status === 400) {
            // server had issues with our request
            var response = JSON.parse(xhr.response);
            console.log('got error response %o', response);
            var e = response['error'];
            output.classList.add('text-white', 'bg-danger');
            output.innerHTML = '<b>'+e.type+'</b>: '+e.args;

        } else {
            console.error("server returned %o -> %o", xhr.status, xhr.statusText);
            output.innerHTML = '<i>'+xhr.statusText+'</i>';
            output.classList.add('text-white', 'bg-danger');
        }
        updateProgress(+1);
    };

    // Send 
    xhr.send();
}

function dropHandler(ev) {
    console.log("Drop");
    ev.preventDefault();
    document.querySelector('table').classList.remove('dragover');
    // If dropped items aren't files, reject them
    var dt = ev.dataTransfer;
    // Create a new FormData object.
    var formData = new FormData();
    if (dt.items) {
      // Use DataTransferItemList interface to access the file(s)
      for (var i=0; i < dt.items.length; i++) {
        if (dt.items[i].kind == "file") {
          var f = dt.items[i].getAsFile();
          console.log("... file[" + i + "].name = %o",f);
          // Add the file to the request.
          formData.append('xmeml', f, f.name);
        }
      }
    } else {
      // Use DataTransfer interface to access the file(s)
      for (var i=0; i < dt.files.length; i++) {
        var f = dt.files[i];
        console.log("... file[" + i + "].name = %o",f);
        // Add the file to the request.
        formData.append('xmeml', f, f.name);
      }  
    }
    submit(formData)
  }

  function dragoverHandler(ev) {
    console.log("dragOver");
    // Prevent default select and drag behavior
    ev.preventDefault();
    document.querySelector('table').classList.add('dragover');
    window.setTimeout(function() {
        document.querySelector('table').classList.remove('dragover');
    }, 10000)
  }

  function dragendHandler(ev) {
    console.log("dragEnd");
    document.querySelector('table').classList.remove('dragover');
    // Remove all of the drag data
    var dt = ev.dataTransfer;
    if (dt.items) {
      // Use DataTransferItemList interface to remove the drag data
      for (var i = 0; i < dt.items.length; i++) {
        dt.items.remove(i);
      }
    } else {
      // Use DataTransfer interface to remove the drag data
      ev.dataTransfer.clearData();
    }
  }

function alertmsg(msg, errortype) {
  var e = document.getElementById('alertmsg');
  var etype = errortype || 'warning';
  e.innerText = msg;
  e.classList.add('alert-'+etype);
  e.hidden=false;
  window.setTimeout(function() {e.hidden=true; 
                                e.classList.remove('alert-'+etype); 
                                e.innerText='';}, 
                            4500);
}

function creditsdialog() {
    // pop up  a dialog suitable for copy-paste into end credits
    var metadatarows = document.querySelectorAll('td.has-metadata');
    var s = "";
    var _labels = [];
    for(var i=0; i<metadatarows.length; i++) {
        var md = metadatarows[i].metadata;
        if(md.title===undefined) { continue }
        if(md.productionmusic===true) {
            if(_labels.indexOf(md.label) === -1) { // only register once per label
                s = s + "<i>"+md.copyright+"</i> <br>&reg; <b>"+md.label+"</b><br>";
            }
        } else {
            s = s + "<i>"+md.title+"</i> "+md.artist+" <br>&reg; <b>"+md.label+"</b> "+md.year;
        }
    }
    console.log('got credits: %o', s);
    window.modalmodal.setContent('<h1>End credits</h1>'+s);
    window.modalmodal.open();
}

function runsheetdialog() {
    // pop up a run sheet dialog, listing each track by inpoint on timeline on timeline
    var metadatarows = document.querySelectorAll('td.has-metadata');
    var s = "<h1>Tracks by order of entry on timeline</h1>";
    s = s + '<table cellpadding=10><tr>';
    s = s + '<th>In</th>';
    s = s + '<th>Out</th>';
    s = s + '<th>Duration</th>';
    s = s + '<th>Clip details</th>';
    s = s + '</tr>';
    var reportrows = []; // this is where we keep the generated text of each report row
    for(var i=0; i<metadatarows.length; i++) {
        var md = metadatarows[i].metadata;
        var td = metadatarows[i].timelinedata;
        console.log("got timelinedata: %o", td);
        var t;
        if(md.title===undefined) {// TODO: let people choose ordinary files also 
            t = td.filename; 
        } else {
            t = '\u00ab'+md.title+'\u00bb \u2117 '+td.musiclibrary
            //_t = u'\u00ab%(title)s\u00bb \u2117 %(musiclibrary)s' % vars(r.metadata)
        }
        if(md.productionmusic===true) {
            if(_labels.indexOf(md.label) === -1) { // only register once per label
                s = s + "<i>"+md.copyright+"</i> &reg; <b>"+md.label+"</b><br>";
            }
        } else {
            s = s + "<i>"+md.title+"</i> "+md.artist+" &reg; <b>"+md.label+"</b> "+md.year;
        }
    }
    console.log('got credits: %o', s);
    window.modalmodal.setContent('<h1>End credits</h1>'+s);
    window.modalmodal.open();
}

function reportdialog() {
    // pop up a prf report, detailing the metadata details
    var metadatarows = document.querySelectorAll('td.has-metadata');
    var reportrows = []; // this is where we keep the generated text of each report row
    for(var i=0; i<metadatarows.length; i++) {
        var md = metadatarows[i].metadata;
        var td = metadatarows[i].timelinedata;
        console.log("got timelinedata: %o", td);
        var t = md.title || td.title;// TODO: let people choose ordinary files also 
        var _s = "<div><dt>Title:</dt><dd>"+t+"</dd>";
        if(md.identifier)
            _s = _s + "<dt>Track identifier:</dt><dd>"+md.identifier+"</dd>";
        if(md.artist)
            _s = _s + "<dt>Artist:</dt><dd>"+md.artist+"</dd>";
        if(md.albumname)
            _s = _s + "<dt>Album name:</dt><dd>"+md.albumname+"</dd>";
        if(md.lyricist)
            _s = _s + "<dt>Lyricist:</dt><dd>"+md.lyricist+"</dd>";
        if(md.composer)
            _s = _s + "<dt>Composer:</dt><dd>"+md.composer+"</dd>";
        if(md.label)
            _s = _s + "<dt>Label:</dt><dd>"+md.label+"</dd>";
        if(md.recordnumber)
            _s = _s + "<dt>Recordnumber:</dt><dd>"+md.recordnumber+"</dd>";
        if(md.copyright)
            _s = _s + "<dt>Copyright owner:</dt><dd>"+md.copyright+"</dd>";
        if(md.year)
            _s = _s + "<dt>Released year:</dt><dd>"+md.year+"</dd>";
        
        _s = _s + "<br><b>Seconds in total</b>: "+secs2timestring(td.audible_length)+"</div><hr>";
        reportrows.push(_s);
    }
    window.modalmodal.setContent("<h1>Track metadata sheet for PRF</h1>"+reportrows.join("\n"));
    window.modalmodal.open();
}

/*
clips = defaultdict(list)
for r in self.itercheckedrows():
    if r.metadata.title is None:
        # not resolved, use file name
        _t = repr(r.audioname)
    else:
        _t = u'\u00ab%(title)s\u00bb \u2117 %(musiclibrary)s' % vars(r.metadata)
    for sc in r.subclips:
        _s = '<tr><td><code>%s</code></td><td><code>%s</code></td>' % (sc['in'], sc['out'])
        _s += '<td>%06.2f\"</td>' % (sc['durationsecs'])
        _s += '<td>%s</td>' % _t
        _s += "</tr>"
        clips[sc['in']].append(_s)
# sort all clips by inpoint
inpoints = list(clips.keys())
inpoints.sort()
s = s + "".join(["".join(clips[inpoint]) for inpoint in inpoints])
s = s + '</table>'
*/

</script>

</head>
<body>

    <h1>Pling Plong Odometer Online</h1>
    <div style="font-size: smaller">
        <a href="/doc">JSON Rest API docs (Swagger)</a>
    </div>

    <div id=alertmsg class="fade show alert" role="alert" hidden>
    </div>

    <form id="file-form" enctype="multipart/form-data" action="/analyze" method="POST">
    <input type="file" id="file-select" name="xmeml">
    <input type="hidden" name="usetestfile" value="0">
    <button type="submit" id="upload-button">Upload</button>
    <button type="submit" id="upload-testfile-button">Use testfile</button>
    <button id="resolve-all-button">Resolve all</button>
    <span class=mx-5></span>
    <button id="create-report-button">Generate metadata report</button>
    <button id="create-credits-button">Generate credits</button>
    </form>

    <table class="table table-striped table-sm"
        ondrop="dropHandler(event);" 
        ondragover="dragoverHandler(event);" 
        ondragend="dragendHandler(event);">
        <col style="width:40%">
        <col style="width:10%">
        <col style="width:10%">
        <col style="width:60%">
        <thead class="thead-dark">
            <th>name</th>
            <th>audible length</th>
            <th>&reg;</th>
            <th id="th-metadata">metadata</th>
        </thead>
        <tbody id=files-list style="font-size:80%">

        </tbody>

    </table>

<script type="text/javascript">
main()
</script>
</body>

</html>
