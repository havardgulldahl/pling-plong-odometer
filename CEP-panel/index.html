<!doctype html>

<html>
	<head>
		<meta charset="utf-8">
		<script src="./ext.js"></script>
		<script src="./lib/CSInterface.js"></script>
		<script src="./lib/jquery-1.9.1.js"></script>
		<script src="./lib/Vulcan.js"></script>
		<link href="css/style.css" rel="stylesheet" type="text/css">
		<script type="text/javascript">

			$( document ).ready(function() {

				// For functions which require interaction at the JavaScript level, we provide these JQuery-based
				// handlers, instead of directly invoking ExtendScript .This givs the JavaScript layer a chance
				// to pass data into the ExtendScript layer, and process the results.

				$("#copypresets").on("click", function(e){
					e.preventDefault(); 

					var csInterface = new CSInterface();
					var OSVersion   = csInterface.getOSInformation();
					var path      	= csInterface.getSystemPath(SystemPath.EXTENSION);

					csInterface.evalScript('$._PPP_.getUserName()', myUserNameFunction);  

					if (OSVersion){

						// The path always comes back with '/' path separators. Windows needs '\\'.

						if (OSVersion.indexOf("Windows") >=0){
							var initPath = 'C:\\Users\\' + username.innerHTML;
							var sep = '\\\\';
							path = path.replace(/\//g, sep);
						} else {
							var initPath = '/Users/' + username.innerHTML;
							var sep = '/';
						}
					
						path = path + sep + 'payloads' + sep + 'Effect\ Presets\ and\ Custom\ Items.prfpset';

						var readResult = window.cep.fs.readFile(path);

						if (0 == readResult.err){

							// We build a path to the preset, based on the OS user's name.
							
							var addOutPath	= '/Documents/Adobe/Premiere\ Pro/12.0/Profile-' + username.innerHTML + '/Effect\ Presets\ and\ Custom\ Items.prfpset';
							var fullOutPath = initPath + addOutPath;
							var writeResult = window.cep.fs.writeFile(fullOutPath, readResult.data);
					
							if (0 == writeResult.err){
								alert("Successfully copied effect presets from panel to user's configuration."); //result.data is file content
							} else {
								alert("Failed to copy effect presets.");
							}
						}
					}
				});

				$("#openfolder").on("click", function(e){
					e.preventDefault(); 
					var csInterface = new CSInterface();
					var OSVersion   = csInterface.getOSInformation();
					var path    	= csInterface.getSystemPath(SystemPath.EXTENSION);

					if (OSVersion){
						// The path always comes back with '/' path separators. Windows needs '\\'.
						if (OSVersion.indexOf("Windows") >=0){
							var sep = '\\\\';
							path = path.replace(/\//g, sep);
							window.cep.process.createProcess('C:\\Windows\\explorer.exe', path);
						} else {
							window.cep.process.createProcess('/usr/bin/open', path);
						}
					}
				});

				$("#btn_PPROx33").on("click", function(e){
					e.preventDefault(); 
					var csInterface = new CSInterface();
					var OSVersion   = csInterface.getOSInformation();
					var path    	= csInterface.getSystemPath(SystemPath.EXTENSION);
					console.log("we got jquery: %o", jQuery);
					var url = 'http://localhost:8000/resolve/ApolloMusic/Apollo_WPM_47_1__Drive-in-Lullaby__Daniel-Woodward___APOLLO.mp3';
					jQuery.getJSON(url, function(data) {
						console.log('we got json data %o', data);
					});
					console.log('global: %o, %o, %o', window.require, null, null);
					var backbone = require('fs');
					console.log('backbone: %o', backbone);


				});

				var csInterface = new CSInterface();
				csInterface.addEventListener("no.nrk.odometer.events.FCPXMLWritten", function(event){
					// event will be a javascript object (csInterface does JSON.parse() behind the scenes)
					// with the following properties
					//  .type == "no.nrk.odometer.events.FCPXMLWritten" 
					//  .data == js object
					console.log("New FCPXML file detected: %o", event);
					var output = document.getElementById("output");
					output.innerText = JSON.stringify(event.data);
					/*
					var reader = new FileReader();
					reader.onload = function(e) {
						// triggered when file is read
						var rawData = reader.result;
						console.log("read file: %o", rawData);
					}
					var f = new File("", event.data.filename);
					reader.readAsBinaryString(f);
					*/
					var result = window.cep.fs.readFile(event.data.filename);
					if(result.err === 0){
						//success
						//result.data is file content
						output.innerText = "successfuly read data";
						console.log("read %s bytes", result.data.length);
						var blob = new Blob([result.data], {type : 'text/xml'});
						var form = new FormData();
						form.append("xmeml", blob, "test.xml");
						console.log("created form %o", form);
						jQuery.ajax({
							url: "http://localhost:8000/analyze",
							method: "POST",
							dataType: "json",
							data: form,
							processData: false,
							contentType: false,
							success: function(result){
								console.log("succes: %o", result);
								var s = "read audioclips: " + result.audioclips.length;
								output.innerText = s;
							},
							error: function(er){
								console.log("error: %o", er);
							}
						});

					} else {

						output.innerText = "file read failed";
					}
				});
			});
		</script>
	</head>

	<body onLoad="onLoaded()">
		<a href="javascript:history.go(0)">Refresh panel</a>
		<div id="section1" class="sectionID">
			<button class="controlBg textStyle" id="btn_PPROx33">Test panel code </button>
			<button class="controlBg textStyle" id="btn_PPRO33333" onClick="evalScript('$._PPP_.odometer()')">test application code </button>
		</div>
		<textarea id=output rows=8 style="width:100%;border:1px solid white"></textarea>
	</body>
	<script>
		document.body.onbeforeunload = function() {
			var csInterface		= new CSInterface();
		    var OSVersion		= csInterface.getOSInformation();
		    var appVersion		= csInterface.hostEnvironment.appVersion;
		    var versionAsFloat	= parseFloat(appVersion);

		    if (versionAsFloat < 10.3){
			    var path = "file:///Library/Application Support/Adobe/CEP/extensions/PProPanel/payloads/onbeforeunload.html";
			    
			    if (OSVersion.indexOf("Windows") >=0){
					path = "file:///C:/Program%20Files%20(x86)/Common%20Files/Adobe/CEP/extensions/PProPanel/payloads/onbeforeunload.html"
			    }
			    csInterface.openURLInDefaultBrowser(path);		
		    }
	  	};

		var createFolders = function() {
		  var csInterface = new CSInterface();
		  csInterface.callScript(
		    '_PPP_',
		    'createDeepFolderStructure',
		    function(res) {
		      console.log('Successfully created folders!');
		    },
		    function(err) {
		      console.error(err);
					alert(err.message);
		    },
				['This', 'is', 'a', 'very', 'deep', 'folder', 'structure'], // 1st argument
				6 // 2nd argument
		  );
		};

	</script>
	</script>
</html>
